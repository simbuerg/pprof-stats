---
title: "PolyJIT Experiments"
output:
  html_document:
    css: pjit-experiments.css
    fig_caption: yes
    fig_height: 4
    fig_width: 16
    highlight: null
    number_sections: yes
    theme: null
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
library(RPostgres)
library(DT)
library(gridExtra)
library(ggplot2)
#library(cowplot)
```

# All experiments in the database

```{r db_setup, echo=FALSE, include=FALSE}
d <- pprof::login.data('.pglogin')
login <- d[d$name == 'bb',]
db <- dbConnect(RPostgres::Postgres(),
                 dbname = as.character(login$dbname),
                 user = as.character(login$user),
                 password = as.character(login$password),
                 port = as.character(login$port),
                 host = as.character(login$host))
exps <- pprof::get_experiments(db)
```

This provides an overview of all experiments available in the database.
```{r db_info, echo=FALSE}
DT::datatable(exps)
```

# Compilestats
```{r setup_db, echo=FALSE, include=FALSE}
query <- paste("
          SELECT
            experiment.description,
            run.project_name AS project,
            cs.name,
            cs.component AS DEBUG_TYPE,
            SUM(cs.VALUE) AS cs_value
          FROM
            run,
            compilestats AS cs,
            project,
            experiment
          WHERE
            run.id = cs.run_id AND
            run.experiment_group = experiment.id AND
            run.project_name = project.name AND
            cs.name = 'Number of instrumented functions' AND
            cs.component IN ('polyjit', 'polly')
          GROUP BY experiment.description, run.project_name, cs.name, cs.component;
")
res <- pprof::sql.get(db, query)
res.filtered <- subset(res, cs_value < 100000)
```

In the following paragraphs, we see the number of functions instrumented by
PolyJIT.

```{r, echo=FALSE}
DT::datatable(res.filtered)
```

## Jitterplot
```{r, echo=FALSE}
ggplot(res.filtered, aes(y = description, x = cs_value, color = description, fill = description)) +
  theme(legend.position="none") +
  geom_jitter(size=0.2) +
  scale_x_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  labs(title = "Jitter plot, per experiment (Value Range: [1, 50])",
       y = "Experiment")
```

## Density area plot
```{r, echo=FALSE}
ggplot(res.filtered, aes(x = cs_value, color = description, fill = description)) +
  geom_density(position="fill", alpha=0.1) +
  scale_x_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  labs(title = "Density area plot, per experiment (Value Range: [1, 50])")
```

## Violin density plot
```{r, echo=FALSE}
ggplot(res.filtered, aes(x = description, y = cs_value, color = description, fill = description)) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") +
  scale_y_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  geom_violin() +
  labs(title = "Violin density plot, per experiment",
       y = "Instrumented Functions")
```


# Runtime Experiments

The following paragraphs show various results in the context of runtime experiments.

## Baselines vs Pivot

```{r, echo = FALSE, include = FALSE}
bl <- c(
  '73d220af-c6fa-4e9e-b68a-2d58a2329c1c', # 2015-11-27 (SemiAsync)
  '5b1385cc-2f22-4361-a0e9-b91df4b310d4'  # =spawn-chimaira-173
  )
piv <- bl
d <- pprof::baseline_vs_pivot(db, bl, piv, NULL, NULL)

d.filtered <- subset(d, num_cores %in% c(1, 2, 4, 8, 10))
d.filtered <- subset(d.filtered, bid != gname)
d.filtered <- subset(d.filtered, speedup < 20)

drops <- c("bid", "pname", "bname")
d.table <- d.filtered[ , !(names(d.filtered) %in% drops)]

```

```{r, echo = FALSE}
DT::datatable(d.table)
p <- ggplot(data = d.filtered, aes(x = factor(num_cores), y = speedup, colour = pid)) +
  geom_boxplot(aes(group = num_cores), outlier.size = 0) +
  facet_grid(gname ~ bid)
p
```

```{r, echo = FALSE}
DT::datatable(d.table)
p <- ggplot(data = d.filtered, aes(x = project, y = speedup, fill = factor(num_cores))) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ gname) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none")
p
```
