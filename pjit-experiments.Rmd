---
title: "PolyJIT Experiments"
output:
  html_document:
    css: pjit-experiments.css
    fig_caption: yes
    fig_height: 4
    fig_width: 16
    highlight: pygments
    number_sections: yes
    theme: null
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
library(RPostgres)
library(DT)
library(gridExtra)
library(ggplot2)
#library(cowplot)
```

# All experiments in the database

```{r db_setup, echo=FALSE, include=FALSE}
```

This provides an overview of all experiments available in the database.
```{r db_info, eval=FALSE, echo=FALSE}
DT::datatable(exps)
```

# Compilestats
```{r setup_db, echo=FALSE, include=FALSE}
query <- paste("
          SELECT
            experiment.description,
            run.project_name AS project,
            cs.name,
            cs.component AS DEBUG_TYPE,
            SUM(cs.VALUE) AS cs_value
          FROM
            run,
            compilestats AS cs,
            project,
            experiment
          WHERE
            run.id = cs.run_id AND
            run.experiment_group = experiment.id AND
            run.project_name = project.name AND
            cs.name = 'Number of instrumented functions' AND
            cs.component IN ('polyjit', 'polly')
          GROUP BY experiment.description, run.project_name, cs.name, cs.component;
")
res <- pprof::sql.get(db, query)
res.filtered <- subset(res, cs_value < 100000)
```

In the following paragraphs, we see the number of functions instrumented by
PolyJIT.

```{r, eval=FALSE, echo=FALSE}
DT::datatable(res.filtered)
```

## Jitterplot
```{r, echo=FALSE}
ggplot(res.filtered, aes(y = description, x = cs_value, color = description, fill = description)) +
  theme(legend.position="none") +
  geom_jitter(size=0.2) +
  scale_x_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  labs(title = "Jitter plot, per experiment (Value Range: [1, 50])",
       y = "Experiment")
```

## Density area plot
```{r, eval=FALSE, echo=FALSE}
ggplot(res.filtered, aes(x = cs_value, color = description, fill = description)) +
  geom_density(position="fill", alpha=0.1) +
  scale_x_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  labs(title = "Density area plot, per experiment (Value Range: [1, 50])")
```

## Violin density plot
```{r, eval=FALSE, echo=FALSE}
ggplot(res.filtered, aes(x = description, y = cs_value, color = description, fill = description)) +
  theme(axis.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position="none") +
  scale_y_continuous(limits = c(1,50), breaks = seq(0,50,5)) +
  geom_violin() +
  labs(title = "Violin density plot, per experiment",
       y = "Instrumented Functions")
```


# Runtime Experiments

The following paragraphs show various results in the context of runtime experiments.

## Baselines vs Pivot

```{r, eval=FALSE, echo = FALSE, include = FALSE}
bl <- c(
  '73d220af-c6fa-4e9e-b68a-2d58a2329c1c', # 2015-11-27 (SemiAsync)
  'c0a1199f-208f-4ccb-adf6-bf1bf71afa74' #spawn-chimaira-176 
  )
piv <- bl
d <- pprof::baseline_vs_pivot(db, bl, piv, NULL, NULL)

d.filtered <- subset(d, num_cores %in% c(1, 2, 4, 8, 10))
d.filtered <- subset(d.filtered, bid != gname)
d.filtered <- subset(d.filtered, speedup < 20)

drops <- c("bid", "pname", "bname")
d.table <- d.filtered[ , !(names(d.filtered) %in% drops)]

```

```{r, eval=FALSE, echo = FALSE}
DT::datatable(d.table)
p <- ggplot(data = d.filtered, aes(x = factor(num_cores), y = speedup, colour = pid)) +
  geom_boxplot(aes(group = num_cores), outlier.size = 0) +
  facet_grid(gname ~ bid)
p
```

```{r, eval=FALSE, include=FALSE}
plots <- lapply(piv, function(x, d) {
  d.sub <- subset(d, baseline_id == x)
  return(ggplot(data = d.sub, aes(x = project, y = speedup, fill = factor(num_cores))) +
    geom_bar(stat = "identity", position = "dodge") +
    facet_grid(gname ~ bid) +
    theme(axis.text = element_text(size = 8), axis.text.x = element_text(angle = 45, hjust = 1),
          legend.position="none"))
}, d.filtered)
plots
```

## Per project speedup

```{r, eval=FALSE, include=FALSE}
if (!require(gtools)) {
  install.packages("gtools")
}
library(gtools)
```
```{r, eval=FALSE, message=FALSE, include=FALSE}
experiments_from_db <- exps[exps$name %in% c('pj-raw', 'raw'),]$id
experiments <- gtools::permutations(length(experiments_from_db), 2, experiments_from_db)

plots <- apply(experiments, 1, function(elem, db) {
  baseline <- exps[exps$id == elem[1],]$description
  experiment <- exps[exps$id == elem[2],]$description
  speed <- sql.get(db, query_speedup_no_papi('', elem[1], elem[2]))

  if (length(unique(speed$project_name)) > 30) {
    plot <-ggplot(data = speed, aes(x = project_name, y = speedup_corrected, fill = factor(cores))) +
      geom_bar(stat="identity", position = "dodge") +
      theme(axis.text = element_text(size = 8), axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position="none") +
      labs(title = paste("Baseline: ", baseline, " vs. ", experiment))
    return(plot)
  }
  return(NULL)
}, db)
plots[!is.null(plots)]
```

## PolyBench
```{r, echo = FALSE, message=FALSE}

if (!require(reshape2)) { install.packages("reshape2") }
library(reshape2)
if (!require(rpivotTable)) { install.packages("rpivotTable")}
library(rpivotTable)

experiments_from_db <- exps[exps$name %in% c('pj-raw', 'raw'),]
time_real_s <- db_real_time_s(db, group = c('polybench'))
time_real_s.m <- reshape2::melt(time_real_s, id.var = c("experiment_group", "description", "project_name", "cval"))
  
#time_real_s.c <- reshape2::recast(time_real_s, project_name ~ description + cval, fun.aggregate = min, measure.var = c("mval"), id.var = c("experiment_group", "description", "project_name", "cval"))
rpivotTable(time_real_s.m, rows = c("project_name"), vals = c("mvar"), cols = c("cval", "description"), width = "100%", height = "800px")
```

## LNT
```{r, echo = FALSE, message=FALSE}

if (!require(reshape2)) { install.packages("reshape2") }
library(reshape2)
if (!require(rpivotTable)) { install.packages("rpivotTable")}
library(rpivotTable)

experiments_from_db <- exps[exps$name %in% c('pj-raw', 'raw'),]
time_real_s <- db_real_time_s(db, group = c('lnt'))
time_real_s.m <- reshape2::melt(time_real_s, id.var = c("experiment_group", "description", "project_name", "cval"))
  
#time_real_s.c <- reshape2::recast(time_real_s, project_name ~ description + cval, fun.aggregate = min, measure.var = c("mval"), id.var = c("experiment_group", "description", "project_name", "cval"))
rpivotTable(time_real_s.m, rows = c("project_name"), vals = c("mvar"), cols = c("cval", "description"), width = "100%", height = "800px")
```

## PPROF
```{r, echo = FALSE, message=FALSE}

if (!require(reshape2)) { install.packages("reshape2") }
library(reshape2)
if (!require(rpivotTable)) { install.packages("rpivotTable")}
library(rpivotTable)

experiments_from_db <- exps[exps$name %in% c('pj-raw', 'raw'),]
time_real_s <- db_real_time_s(db, group = c('pprof'))
time_real_s.m <- reshape2::melt(time_real_s, id.var = c("experiment_group", "description", "project_name", "cval"))
  
#time_real_s.c <- reshape2::recast(time_real_s, project_name ~ description + cval, fun.aggregate = min, measure.var = c("mval"), id.var = c("experiment_group", "description", "project_name", "cval"))
rpivotTable(time_real_s.m, rows = c("project_name"), vals = c("mvar"), cols = c("cval", "description"), width = "100%", height = "800px")
```

